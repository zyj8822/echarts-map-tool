<!Doctype html>
<html>

<head>
    <title>ECharts 地图数据在线生成工具</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" href="lib/highlight/styles/atelier-dune.light.css">
</head>

<body>
    <div class="container-fluid navbar-default">
        <div class="navbar-header">
            <button type="button" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false"
                class="navbar-toggle collapsed"><span class="sr-only">Toggle navigation</span><span
                    class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a
                href="http://echarts.baidu.com/index.html" class="navbar-brand"><img
                    src="https://www.echartsjs.com/zh/images/logo.png" alt="echarts logo" class="navbar-logo" /></a>
        </div>
        <div id="navbar-collapse" class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-left">
                <li id="nav-index"><a href="http://echarts.baidu.com/index.html">首页</a></li>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li id="nav-github"><a href="https://github.com/ecomfe/echarts" target="_blank"><img
                            src="https://www.echartsjs.com/zh/images/github.png" width="18" /></a></li>
                <li id="nav-2" class="0"><a href="http://echarts.baidu.com/echarts2/">2.0</a></li>
                <li id="nav-homeen"><a href="https://ecomfe.github.io/echarts-doc/public/en/index.html">EN</a></li>
            </ul>
        </div>
    </div><!-- end of navbar -->
    <div class="container" id="main">
        <div class="row">
            <div id="configuration" class="col-sm-4">
                <section id="range">
                    <h3>范围<span> range</span></h3>
                    <p>
                        <label for="province">省:</label>
                        <select id='province'></select>
                    </p>

                    <p>
                        <label for="province">市:</label>
                        <select id='city'>
                            <option>-- 所有城市 --</option>
                        </select>
                    </p>

                    <p>
                        <label for="province">县:</label>
                        <select id='district'>
                            <option>-- 所有区县 --</option>
                        </select>
                    </p>
                </section>
                <section id="type">
                    <h3>是否包含子区域<span> subregion</span></h3>
                    <p>
                        <input type="radio" name="type" value="outline" id="outline" checked="checked">
                        <label for="outline">否</label>
                        <p class="desc">地图数据仅包括所选区域的外围轮廓</p>
                    </p>
                    <p>
                        <input type="radio" name="type" value="outlineAndPartition" id="outlineAndPartition">
                        <label for="outlineAndPartition">是</label>
                        <p class="desc">地图数据包括所选区域的外围轮廓, 以及内部子区域轮廓
                            <span class="desc-warning">(对于 "区县" 粒度的区域, 默认仅生成外轮廓)</span>
                        </p>
                    </p>
                </section>

                <div id="action">
                    <button id="buildJs" class="btn btn-primary">生成 JS</button>
                    <button id="buildJson" class="btn btn-primary">生成 JSON</button>
                    <button id="startDownJSON" class="btn btn-primary">下载省JSON</button>
                </div>
            </div>
            <div class="col-sm-8">
                <section id="preview">
                    <h3>预览<span> preview</span></h3>
                    <div id="preview-viewport"></div>
                </section>
            </div>
        </div>
    </div>

    <script type="text/javascript"
        src="http://webapi.amap.com/maps?v=1.3&key=9d4f5c2078ba12cb9d9d09c4e81c95d0"></script>
    <script src="lib/jquery.js"></script>
    <script src="lib/bootstrap.min.js"></script>
    <script src='lib/FileSaver.min.js'></script>
    <script src="lib/echarts.js"></script>
    <script src="js/download.js"></script>
    <script src="lib/highlight/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>

        // -- 初始化全局变量 --

        // 地图接口对象
        var mapObj;

        // DistrictSearch对象
        var district;

        // 区县所在城市的城市编码, 用于搜索重名区域时确定具体区县
        var citycode;

        // 保存文件的名称
        var fileStr = '';

        var NO_COUNTY = ['东莞市', '中山市', '三沙市', '儋州市', '嘉峪关市'];

        // 是否是直辖市
        var isCentralCity = false;

        // 是否是香港澳门
        var isAomenOrHK = false;

        // 是否是台湾
        var isTaiwan = false;

        // -- 初始化下拉列表 --

        var INIT_PROVINCE_CONTENT = '<option>--  所有省(行政区,直辖市)  --</option>';
        var INIT_CITY_CONTENT = '<option>--  所有城市  --</option>';
        var INIT_DISTRICT_CONTENT = '<option>--  所有区县  --</option>';
        var INIT_DEFAULT_CONTENT = '<option>--  全部  --</option>';

        var provinceList = ['河北省', '山西省', '内蒙古自治区', '辽宁省', '吉林省', '黑龙江省', '江苏省', '浙江省', '安徽省', '福建省', '江西省', '山东省', '河南省', '湖北省', '湖南省', '广东省', '广西壮族自治区', '海南省', '四川省', '贵州省', '云南省', '西藏自治区', '陕西省', '甘肃省', '青海省', '宁夏回族自治区', '新疆维吾尔自治区'];

        var content = INIT_PROVINCE_CONTENT;

        // 省,自治区
        provinceList.push("北京市");
        provinceList.push("上海市");
        provinceList.push("天津市");
        provinceList.push("重庆市");
        provinceList.push("香港");
        provinceList.push("澳门");
        provinceList.push("台湾省");

        for (var i = 0, l = provinceList.length; i < l; i++) {
            content += '<option value="province">' + provinceList[i] + '</option>';
        }

        $('#province').html(content);


        // -- 开启地图服务 --

        AMap.service(["AMap.DistrictSearch"], function () {
            var opts = {
                subdistrict: 1,   //返回下一级行政区
                extensions: 'all',  //返回行政区边界坐标组等具体信息
                level: 'city'  //查询行政级别为 市
            };

            // 实例化DistrictSearch
            district = new AMap.DistrictSearch(opts);
        });

        function updateAndFetch(cb) {
            // 选中的范围
            var selectProvince = $('#province').find("option:selected");

            var selectCity = $('#city').find("option:selected");
            var selectDistrict = $('#district').find("option:selected");

            // 范围初始值
            var trimProvince = INIT_PROVINCE_CONTENT.replace(/<option>(.*?)<\/option>/g, "$1");
            var trimCity = INIT_CITY_CONTENT.replace(/<option>(.*?)<\/option>/g, "$1");
            var trimDistrict = INIT_DISTRICT_CONTENT.replace(/<option>(.*?)<\/option>/g, "$1");

            // 是否仅有轮廓
            var isOnlyOutline = $("input[name='type']:checked").val() == 'outline' ? true : false;

            // 地图范围等级: 3-中国, 2-省(直辖市,行政区) 1-市, 0-地区
            var getType = 0;

            // 直辖市或行政区
            if (isAomenOrHK || isCentralCity) {
                if (selectDistrict.text() == trimDistrict) {
                    getType = 2;
                } else {
                    getType = 0;
                }
                // 普通省市
            } else {
                if (selectProvince.text() == trimProvince) {
                    getType++;
                }

                if (selectCity.text() == trimCity) {
                    getType++;
                }

                if (selectDistrict.text() == trimDistrict) {
                    getType++;
                }
            }
            switch (getType) {
                case 3:
                    fileStr = '中国';
                    fetchGeoJson('中国', isOnlyOutline, false, cb);
                    getType = 0;
                    break;
                case 2:
                    fileStr = selectProvince.text();
                    fetchGeoJson(selectProvince, isOnlyOutline, false, cb);
                    getType = 0;
                    break;
                case 1:
                    fileStr = selectCity.text();
                    fetchGeoJson(selectCity, isOnlyOutline, false, cb);
                    getType = 0;
                    break;
                case 0:
                    fileStr = selectDistrict.text();
                    fetchGeoJson(selectDistrict, true, false, cb);
                    getType = 0;
                    break;
                default:
                    getType = 0;
                    alert('请选择正确的地图范围');
            }
        }


        // -- dom事件绑定 --

        $('#type input').change(function () {
            // 更新预览
            updateAndFetch(preview);
        });

        // 绑定生成按钮点击事件，触发生成地图数据并下载
        $('#buildJson').click(downloadJson);

        function downloadJson() {
            updateAndFetch(function (geoJson) {
                downloadGeoJson(geoJson);
            });
        }

        // 监听省级下拉列表变化
        $('#province').change(provinceSelectCallback);

        function provinceSelectCallback() {

            $('#city').removeAttr("disabled");
            $('#district').removeAttr("disabled");
            $('#outlineAndPartition').removeAttr("disabled");
            var arrTemp = $(this).val().split('|');
            // 行政级别
            var level = arrTemp[0];
            // 城市编码
            citycode = arrTemp[1];
            // 关键字
            var keyword = $(this).find("option:selected").text();

            // 判断是否是直辖市
            isCentralCity = false;

            // 判断是否是香港澳门
            isAomenOrHK = false;

            // 判断是否是台湾
            isTaiwan = false; //isSpecialCity(keyword, TAIWAN);

            // 直辖市和行政区时，禁用市级下拉列表
            if (isAomenOrHK || isCentralCity) {
                $('#city').html(INIT_CITY_CONTENT);
                // $('#city').prop("disabled", true);
            }

            // 直辖市的县级内容为初始状态
            if (isCentralCity) {
                $('#district').html(INIT_DISTRICT_CONTENT);
            }


            var trimProvince = INIT_PROVINCE_CONTENT.replace(/<option>(.*?)<\/option>/g, "$1");

            // 若省级下拉列表为初始化状态，那么设置市级，区级下拉列表也为初始状态
            if (keyword == trimProvince) {
                $('#city').html(INIT_CITY_CONTENT);
                $('#district').html(INIT_DISTRICT_CONTENT);

            } else {
                // 行政区级别
                district.setLevel(level);
                // 行政区查询
                district.search(keyword, function (status, result) {
                    getData(result);
                });
            }

            // 更新预览
            updateAndFetch(preview);
        }

        // 监听市级下拉列表变化
        $('#city').change(citySelectCallback);
        function citySelectCallback() {

            $('#outlineAndPartition').removeAttr("disabled");

            // 中国共有五个不设市辖区的地级市
            var keyword = $(this).find("option:selected").text();
            isNoCounty = false;//isSpecialCity(keyword, NO_COUNTY);

            // 没有市辖区的地级市，对他们只能选择外部轮廓
            if (isNoCounty) {
                $('#outline').prop("checked", true);
                // $('#outlineAndPartition').prop("disabled", true);
            }

            var arrTemp = $(this).val().split('|');

            //行政级别
            var level = arrTemp[0];

            // 城市编码
            citycode = arrTemp[1];

            var keyword = $(this).find("option:selected").text();
            var trimCity = INIT_CITY_CONTENT.replace(/<option>(.*?)<\/option>/g, "$1");

            if (keyword == trimCity) {
                $('#district').html(INIT_DISTRICT_CONTENT);
            } else {
                //行政区级别
                district.setLevel(level);
                //行政区查询
                district.search(keyword, function (status, result) {
                    getData(result);
                });
            }

            // 更新预览
            updateAndFetch(preview);
        }

        // 监听区县级下拉列表变化
        $('#district').change(districtSelectCallback);
        function districtSelectCallback() {

            $('#outline').prop("checked", true);

            var trimDistrict = INIT_DISTRICT_CONTENT.replace(/<option>(.*?)<\/option>/g, "$1");

            var arrTemp = $(this).val().split('|');

            //行政级别
            var level = arrTemp[0];
            // 城市编码
            citycode = arrTemp[1];

            var keyword = $(this).find("option:selected").text();
            if (keyword == trimDistrict) {
                $('#outlineAndPartition').removeAttr('disabled');
            }

            //行政区级别
            district.setLevel(level);
            //行政区查询
            district.search(keyword, function (status, result) {
                getData(result);
            });

            // 更新预览
            updateAndFetch(preview);
        }

        // 判断直辖市,行政区
        function isSpecialCity(cityName, list) {
            var isSpecial = false;
            for (var c = 0; c < list.length; c++) {
                if (cityName == list[c]) {
                    isSpecial = true;
                    return isSpecial;
                }
            }
            return isSpecial;
        }

        // 动态加载下拉列表
        function getData(e) {
            var list = e.districtList || [],
                subList = [], level, nextLevel;

            if (list.length >= 1) {
                subList = list[0].districtList;
                level = list[0].level;

                // 清空下一级别的下拉列表
                if (level === 'province') {
                    nextLevel = 'city';
                    $('#city').html(INIT_CITY_CONTENT);
                    $('#district').html(INIT_DISTRICT_CONTENT);
                }
                else if (level === 'city') {
                    nextLevel = 'district';
                    $('#district').html(INIT_DISTRICT_CONTENT);
                }
                else if (level === 'district') {
                    nextLevel = 'biz_area';
                }

                if (subList) {
                    if (subList[0].level == 'city') {
                        initContent = INIT_CITY_CONTENT;
                    } else {
                        initContent = INIT_DISTRICT_CONTENT;
                    }
                    var contentSub = initContent;

                    for (var i = 0, l = subList.length; i < l; i++) {
                        var name = subList[i].name;
                        var levelSub = subList[i].level;
                        var cityCode = subList[i].citycode;
                        contentSub += '<option value="' + levelSub + '|' + cityCode + '">' + name + '</option>';
                    }
                    $('#' + levelSub).html(contentSub);
                }
            }
        }

        var myChart;
        function preview(data) {

            if (downindex > 0) {
                downloadGeoJson(data);
                downindex++;
                set_select_checked();
            }

            if (myChart) {
                myChart.dispose();
            }
            if (!data) {
                document.getElementById('preview-viewport').innerHTML = '无数据';
                return;
            }
            myChart = echarts.init(document.getElementById('preview-viewport'));
            echarts.util.mapData.params.params.preview = {
                getGeoJson: function (callback) {
                    callback(echarts.util.mapData.params.decode(data));
                }
            };
            myChart.setOption({
                series: [
                    {
                        name: '预览',
                        type: 'map',
                        mapType: 'preview',
                        data: [],
                        roam: true,
                        itemStyle: {
                            normal: {
                                borderColor: '#999',
                                color: '#f3f3f3'
                            },
                            emphasis: {
                                borderColor: '#888',
                                color: '#7bb4e5'
                            }
                        }
                    }
                ]
            });
        }

        $('#province').change();

        function set_select_checked() {
            if (downindex > provinceList.length) {
                return;
            }
            let checkValue = provinceList[downindex - 1];
            var select = document.getElementById("province");
            console.log(checkValue + provinceList.length + " : " + downindex);
            for (var i = 0; i < select.options.length; i++) {
                if (select.options[i].text == checkValue) {
                    select.options[i].selected = true;
                    break;
                }
            }
            $('#province').change();
        }

        $('#startDownJSON').click(startDownJSON);
        var downindex = 0;
        function startDownJSON() {
            downindex = 1;
            set_select_checked();
        }
    </script>
</body>