<html>

<head>
    <meta charset="utf-8">
    <title>中国地图</title>
</head>
<style>

</style>

<body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>

        function decode(json) {
            if (!json.UTF8Encoding) {
                return json;
            }
            var encodeScale = json.UTF8Scale;
            if (encodeScale == null) {
                encodeScale = 1024;
            }

            var features = json.features;

            for (var f = 0; f < features.length; f++) {
                var feature = features[f];
                var geometry = feature.geometry;
                var coordinates = geometry.coordinates;
                var encodeOffsets = geometry.encodeOffsets;

                for (var c = 0; c < coordinates.length; c++) {
                    var coordinate = coordinates[c];

                    if (geometry.type === 'Polygon') {
                        coordinates[c] = decodePolygon(
                            coordinate,
                            encodeOffsets[c],
                            encodeScale
                        );
                    } else if (geometry.type === 'MultiPolygon') {
                        for (var c2 = 0; c2 < coordinate.length; c2++) {
                            var polygon = coordinate[c2];
                            coordinate[c2] = decodePolygon(
                                polygon,
                                encodeOffsets[c][c2],
                                encodeScale
                            );
                        }
                    }
                }
            }
            // Has been decoded
            json.UTF8Encoding = false;
            return json;
        }

        function decodePolygon(coordinate, encodeOffsets, encodeScale) {
            var result = [];
            var prevX = encodeOffsets[0];
            var prevY = encodeOffsets[1];

            for (var i = 0; i < coordinate.length; i += 2) {
                var x = coordinate.charCodeAt(i) - 64;
                var y = coordinate.charCodeAt(i + 1) - 64;
                // ZigZag decoding
                x = (x >> 1) ^ (-(x & 1));
                y = (y >> 1) ^ (-(y & 1));
                // Delta deocding
                x += prevX;
                y += prevY;

                prevX = x;
                prevY = y;
                result.push([x / encodeScale, y / encodeScale]);
            }
            return result;
        }

        var width = 1000;
        var height = 1000;

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(0,0)");

        var projection = d3.geo.mercator()
            .center([107, 31])
            .scale(850)
            .translate([width / 2, height / 2]);

        var path = d3.geo.path()
            .projection(projection);


        var color = d3.scale.category20();


        d3.json("tmpjson/aaa.json", function (error, root) {

            if (error)
                return console.error(error);
           //  root = decode(root);
            console.log(root.features);

            svg.selectAll("path")
                .data(root.features)
                .enter()
                .append("path")
                .attr("stroke", "#000")
                .attr("stroke-width", 1)
                .attr("fill", function (d, i) {
                    return color(i);
                })
                .attr("d", path)
                .on("mouseover", function (d, i) {
                    d3.select(this)
                        .attr("fill", "yellow");
                })
                .on("mouseout", function (d, i) {
                    d3.select(this)
                        .attr("fill", color(i));
                });

        });

    </script>

</body>

</html>